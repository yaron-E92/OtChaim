<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:OtChaim.Presentation.MAUI.ViewModels.Tool"
             xmlns:emergencyEvents="clr-namespace:OtChaim.Domain.EmergencyEvents;assembly=OtChaim.Domain"
             x:Class="OtChaim.Presentation.MAUI.Pages.Tool.EmergencyDashboardPage"
             x:DataType="viewModels:EmergencyDashboardViewModel"
             BackgroundColor="{StaticResource Gray100}">

    <Grid RowDefinitions="Auto,*" ColumnDefinitions="*">
        <!-- Header -->
        <VerticalStackLayout Grid.Row="0" Padding="20,20,20,10" Spacing="8">
            <Label Text="ðŸš¨ Emergency Dashboard" Style="{StaticResource Headline}" />
            <Label Text="Monitor and manage emergencies in real time" Style="{StaticResource PrimaryHeadline}" />
        </VerticalStackLayout>

        <!-- Main Content -->
        <Grid Grid.Row="1" ColumnDefinitions="2*,3*" Padding="20" RowSpacing="20" ColumnSpacing="20">
            <!-- Left Panel: Emergency Creation + List -->
                <Frame CornerRadius="16" BackgroundColor="{StaticResource Secondary}" Padding="0" HasShadow="True" Grid.Column="0">
                    <Grid Padding="20" RowDefinitions="Auto,32,Auto,*" ColumnDefinitions="*">
                        <!-- Start New Emergency Button -->
                        <Button Grid.Row="0" Text="Start New Emergency" Command="{Binding ShowCreatePopupCommand}" StyleClass="Primary" Margin="0,0,0,16" />

                        <!-- Section Header for Emergencies List -->
                        <Label Grid.Row="1" Text="Active Emergencies" FontSize="20" FontFamily="OpenSansSemibold" TextColor="{StaticResource Primary}" VerticalOptions="End" />

                        <!-- Emergencies List -->
                        <CollectionView Grid.Row="2" x:Name="EmergenciesList"
                                       ItemsSource="{Binding Emergencies}"
                                       SelectedItem="{Binding SelectedEmergency, Mode=TwoWay}"
                                       HeightRequest="300"
                                       Margin="0,8,0,0" SelectionMode="Single">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="emergencyEvents:Emergency">
                                    <Frame Margin="0,4" Padding="12" CornerRadius="8" BackgroundColor="{StaticResource Secondary}" InputTransparent="True">
                                        <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                                            <Label Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="0" Text="{Binding EmergencyType}" FontFamily="OpenSansSemibold" HorizontalTextAlignment="Center" />
                                            <Label Grid.Column="0" Grid.Row="1" Text="{Binding Location}" FontSize="12" TextColor="{StaticResource Gray600}" />
                                            <Label Grid.Column="1" Grid.Row="1" Text="{Binding Status}" FontSize="12" TextColor="{StaticResource Gray600}" />
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                            <CollectionView.EmptyView>
                                <Label Text="No active emergencies" TextColor="{StaticResource Gray400}" HorizontalOptions="Center" />
                            </CollectionView.EmptyView>
                        </CollectionView>
                    </Grid>
                </Frame>

            <!-- Right Panel: Emergency Details & Actions -->
            <Frame Grid.Column="1" CornerRadius="16" BackgroundColor="{StaticResource Secondary}" Padding="0" HasShadow="True">
                <VerticalStackLayout Padding="16" Spacing="16">
                    <Label Text="Emergency Details" FontSize="20" FontFamily="OpenSansSemibold" TextColor="{StaticResource Primary}" />

                    <!-- Emergency Details -->
                    <VerticalStackLayout IsVisible="{Binding SelectedEmergency, Converter={StaticResource NotNullConverter}}" Spacing="8">
                        <Label Text="{Binding SelectedEmergency.EmergencyType, StringFormat='Type: {0}'}" FontFamily="OpenSansSemibold" />
                        <Label Text="{Binding SelectedEmergency.Location, StringFormat='Location: {0}'}" />
                        <Label Text="{Binding SelectedEmergency.Status, StringFormat='Status: {0}'}" />
                        <Label Text="{Binding SelectedEmergency.Responses.Count, StringFormat='Responses: {0}'}" />
                    </VerticalStackLayout>

                    <!-- Placeholder when no emergency selected -->
                    <Label Text="Select an emergency to view details." 
                           TextColor="{StaticResource Gray400}"
                           IsVisible="{Binding SelectedEmergency, Converter={StaticResource NullConverter}}" />

                    <!-- Action Buttons -->
                    <HorizontalStackLayout Spacing="12" IsVisible="{Binding SelectedEmergency, Converter={StaticResource NotNullConverter}}">
                        <Button Text="Mark as Safe" 
                                Command="{Binding MarkAsSafeCommand}"
                                StyleClass="Primary" 
                                CornerRadius="12"
                                IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />
                        <Button Text="Mark as Not Safe" 
                                Command="{Binding MarkAsNotSafeCommand}"
                                StyleClass="Secondary" 
                                CornerRadius="12" 
                                BackgroundColor="{StaticResource Magenta}" 
                                TextColor="{StaticResource White}"
                                IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />
                        <Button Text="Resolve" 
                                Command="{Binding ResolveEmergencyCommand}"
                                StyleClass="Secondary" 
                                CornerRadius="12" 
                                BackgroundColor="{StaticResource Gray400}" 
                                TextColor="{StaticResource White}"
                                IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Frame>
        </Grid>

                <!-- Popup Overlay for Create Emergency -->
        <ContentView IsVisible="{Binding IsCreatePopupVisible}" 
                     BackgroundColor="#80000000" 
                     Grid.Row="0" Grid.RowSpan="2" Grid.Column="0"
                     ZIndex="1000">
            <ContentView Content="{Binding EmergencyCreationPopup}" 
                         VerticalOptions="Center" 
                         HorizontalOptions="Center" 
                         WidthRequest="500"
                         HeightRequest="600"
                         Margin="20" />
        </ContentView>

        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="2" 
              BackgroundColor="{StaticResource Black}" 
              Opacity="0.5"
              IsVisible="{Binding IsLoading}">
            <ActivityIndicator IsRunning="{Binding IsLoading}" 
                              Color="{StaticResource White}"
                              HorizontalOptions="Center"
                              VerticalOptions="Center" />
        </Grid>
    </Grid>
</ContentView>
